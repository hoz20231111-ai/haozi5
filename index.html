<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¥½å§¿é£Ÿå ‚æ”¶éŠ€ç³»çµ±</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #F1DD95; }
    header { background: #888; color: white; text-align: center; padding: 15px; font-size: 20px; font-weight: bold; }
    .container { padding: 15px; }
    .tabs { display: flex; justify-content: center; gap: 10px; padding: 10px; background: #fffaf0; }
    .tabs button { flex: 1; padding: 10px; font-size: 16px; border: none; border-radius: 6px; cursor: pointer; }
    .active { background: #f7d86d; font-weight: bold; }
    .menu { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px; }
    button { background: #ccc; border: none; border-radius: 8px; padding: 10px; font-size: 16px; cursor: pointer; }
    button:hover { background: #aaa; }
    .card { background: white; border-radius: 10px; padding: 10px; margin: 8px 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    h2 { margin-top: 20px; font-size: 18px; border-bottom: 2px solid #ccc; padding-bottom: 5px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #eee; }
    .flex { display: flex; gap: 10px; flex-wrap: wrap; }
    .hidden { display: none; }
    .white-table { background-color: #ffffff; border: 1px solid #ccc; }
    .white-table th { background-color: #f9f9f9; }
  </style>
</head>
<body>
  <header>å¥½å§¿é£Ÿå ‚æ”¶éŠ€ç³»çµ±</header>

  <div class="tabs">
    <button id="frontTab" class="active" onclick="showPage('front')">å‰å°ç³»çµ±</button>
    <button id="backTab" onclick="showPage('back')">å¾Œå°ç³»çµ±</button>
  </div>

  <div class="container">
    <!-- å‰å° -->
    <div id="frontPage">
      <h2>æ”¶éŠ€ç³»çµ±</h2>
      <div class="menu">
        <button onclick="addItem('åŸå‘³è›‹é¤…',30)">åŸå‘³è›‹é¤… $30</button>
        <button onclick="addItem('ç«è…¿è›‹é¤…',45)">ç«è…¿è›‹é¤… $45</button>
        <button onclick="addItem('èµ·å¸è›‹é¤…',40)">èµ·å¸è›‹é¤… $40</button>
        <button onclick="addItem('ç‰ç±³è›‹é¤…',40)">ç‰ç±³è›‹é¤… $40</button>
        <button onclick="addItem('ç¸½åŒ¯è›‹é¤…',60)">ç¸½åŒ¯è›‹é¤… $60</button>
        <button onclick="addItem('è›‹é¤…çš®',20)">è›‹é¤…çš® $20</button>
        <button onclick="addItem('ç‚¸è›‹è”¥æ²¹é¤…',45)">ç‚¸è›‹è”¥æ²¹é¤… $45</button>
        <button onclick="addItem('å¤§è…¸éºµç·š(å¤§)',55)">å¤§è…¸éºµç·š(å¤§) $55</button>
        <button onclick="addItem('å¤§è…¸éºµç·š(å°)',45)">å¤§è…¸éºµç·š(å°) $45</button>
        <button onclick="addItem('æ¸…éºµç·š(å¤§)',45)">æ¸…éºµç·š(å¤§) $45</button>
        <button onclick="addItem('æ¸…éºµç·š(å°)',35)">æ¸…éºµç·š(å°) $35</button>
        <button onclick="addItem('ç´…èŒ¶',20)">ç´…èŒ¶ $20</button>
        <button onclick="addItem('åŠ 10',10)">åŠ  $10</button>
        <button onclick="addItem('åŠ 20',20)">åŠ  $20</button>
        <button onclick="addItem('åŠ 30',30)">åŠ  $30</button>
        <button onclick="addItem('è›‹',15)">è›‹ $15</button>
        <button onclick="addItem('ç’°ä¿é¤å…·',-5)">ç’°ä¿é¤å…· -$5</button>
      </div>

      <h3>ç•¶å‰è¨‚å–®</h3>
      <div id="orderList"></div>
      <div><b>ç¸½é‡‘é¡: $<span id="totalAmount">0</span></b></div>

      <!-- ğŸ”¹ æ–°å¢ä»˜æ¬¾èˆ‡æ‰¾é›¶åŠŸèƒ½ -->
      <div style="margin-top:10px;">
        <label>é¡§å®¢ä»˜æ¬¾é‡‘é¡: $<input type="number" id="payAmount" min="0" oninput="calcChange()"></label>
      </div>
      <div style="margin-top:5px;">
        <b>æ‡‰æ‰¾é›¶: $<span id="changeAmount">0</span></b>
      </div>

      <div class="flex">
        <button onclick="removeSelectedItem()">åˆªé™¤é¸å–é¤é»</button>
        <button onclick="saveOrder()">é€å‡ºè¨‚å–®</button>
      </div>

      <h3>ä»Šæ—¥éŠ·å”®è¨‚å–®</h3>
      <div id="todayOrders"></div>
      <div class="flex">
        <button onclick="deleteSelectedOrders()">åˆªé™¤é¸å–è¨‚å–®</button>
      </div>
    </div>

    <!-- å¾Œå° -->
    <div id="backPage" class="hidden">
      <h2>å¾Œå°å ±è¡¨</h2>

      <h3>ä»Šæ—¥å“é …çµ±è¨ˆ</h3>
      <table class="white-table">
        <thead><tr><th>å“é …</th><th>æ•¸é‡</th><th>éŠ·å”®é¡</th></tr></thead>
        <tbody id="itemStats"></tbody>
      </table>

      <h3>ç‡Ÿæ¥­é¡çµ±è¨ˆ</h3>
      <table class="white-table">
        <thead><tr><th>é¡åˆ¥</th><th>é‡‘é¡</th></tr></thead>
        <tbody>
          <tr><td>ä»Šæ—¥ç‡Ÿæ¥­é¡</td><td>$<span id="todayRevenue">0</span></td></tr>
          <tr><td>æœ¬é€±ç‡Ÿæ¥­é¡</td><td>$<span id="weekRevenue">0</span></td></tr>
          <tr><td>æœ¬æœˆç‡Ÿæ¥­é¡</td><td>$<span id="monthRevenue">0</span></td></tr>
        </tbody>
      </table>

      <h3>æ­·å²è¨‚å–®æŸ¥è©¢</h3>
      <input type="date" id="historyDate" onchange="renderHistoryByDate()">
      <div id="historyOrders"></div>

      <div class="flex">
        <button onclick="exportCSV()">åŒ¯å‡ºCSV</button>
        <button onclick="clearAllData()">æ¸…é™¤æ‰€æœ‰ç´€éŒ„</button>
      </div>
    </div>
  </div>

<script>
let currentOrder = {};
let allData = JSON.parse(localStorage.getItem("allData")) || { orders: [], history: [], weekRevenue:0, monthRevenue:0 };
let orderNumber = allData.orders.length + 1;

function saveData(){ localStorage.setItem("allData", JSON.stringify(allData)); }

function checkNewDay(){
  let today = new Date().toISOString().split("T")[0];
  let lastDay = localStorage.getItem("lastDay");

  if(lastDay !== today){
    if(allData.orders.length>0){
      allData.history.push({ date:lastDay, orders:allData.orders });
    }

    let dailyTotal = calcTotalWithDiscount(allData.orders);
    allData.weekRevenue = (lastDay ? allData.weekRevenue : 0) + dailyTotal;
    allData.monthRevenue = (lastDay ? allData.monthRevenue : 0) + dailyTotal;

    if(new Date().getDay()===1) allData.weekRevenue = 0;
    if(new Date().getDate()===1) allData.monthRevenue = 0;

    allData.orders = [];
    orderNumber = 1; 
    localStorage.setItem("lastDay", today);
    saveData();
  }
}

function addItem(name, price){
  if(currentOrder[name]) currentOrder[name].qty++;
  else currentOrder[name] = { price, qty:1 };
  renderOrder();
}

function removeSelectedItem(){
  let selected = document.querySelector("input[name='deleteItem']:checked");
  if(selected){
    delete currentOrder[selected.value];
    renderOrder();
  } else {
    alert("è«‹å…ˆé¸æ“‡è¦åˆªé™¤çš„é¤é»");
  }
}

/* ğŸ”¹ å·²åˆä½µçš„æ–° saveOrder() */
function saveOrder(){
  if(Object.keys(currentOrder).length===0){ 
    alert("è«‹å…ˆæ–°å¢é¤é»ï¼"); 
    return; 
  }
  let total=0, items=[];
  for(let k in currentOrder){
    let {price, qty}=currentOrder[k]; 
    total+=price*qty;
    items.push({ name:k, qty, price, subtotal:price*qty });
  }
  let order={ orderNumber:orderNumber++, items,total,time:new Date().toLocaleString() };
  allData.orders.push(order); 
  currentOrder={}; 
  saveData(); 

  // ğŸ”¹é€å‡ºå¾Œè‡ªå‹•æ­¸é›¶ä»˜æ¬¾èˆ‡æ‰¾é›¶
  document.getElementById("payAmount").value = "";
  document.getElementById("changeAmount").innerText = "0";

  renderAll();
}

function clearAllData(){
  if(confirm("âš ï¸ ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿæ‰‹ç™¢å—?æ­¤å‹•ä½œä¸å¯å›å¾©ï¼")){
    if(confirm("âš ï¸ æ‰‹ç™¢å—?ä¸è¦äº‚æŒ‰!!çµ¦æˆ‘æƒ³æ¸…æ¥šå†åˆª")){
      let password = prompt("è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ä»¥ç¢ºèªåˆªé™¤ï¼š");
      if(password === "0000"){   // âœ… åœ¨é€™è£¡æ”¹å¯†ç¢¼
        allData={ orders:[], history:[], weekRevenue:0, monthRevenue:0 }; 
        orderNumber=1; 
        saveData(); 
        renderAll();
        alert("âœ… æ‰€æœ‰è³‡æ–™å·²æ¸…é™¤");
      } else if(password !== null) {
        alert("âŒ å¯†ç¢¼éŒ¯èª¤ï¼Œè³‡æ–™æœªè¢«æ¸…é™¤ï¼");
      }
    }
  }
}

function exportCSV(){
  let rows=[["æ—¥æœŸ","è¨‚å–®ç·¨è™Ÿ","å“é …","æ•¸é‡","å–®åƒ¹","å°è¨ˆ","ç¸½é‡‘é¡"]];
  [...allData.history,{date:"ä»Šæ—¥",orders:allData.orders}].forEach(d=>{
    if(!d.date) return;
    d.orders.forEach(o=>{
      o.items.forEach(i=>{
        let subtotal = (i.name==="ç’°ä¿é¤å…·") ? -5 * i.qty : i.subtotal;
        rows.push([d.date,o.orderNumber,i.name,i.qty,i.price,subtotal,o.total]);
      });
    });
  });
  let csv=rows.map(r=>r.join(",")).join("\n");
  let blob=new Blob([csv],{type:"text/csv"});
  let link=document.createElement("a");
  link.href=URL.createObjectURL(blob); link.download="orders.csv"; link.click();
}

function renderOrder(){
  let box=document.getElementById("orderList"); box.innerHTML="";
  let total=0;
  for(let k in currentOrder){
    let {price,qty}=currentOrder[k], subtotal=price*qty; total+=subtotal;
    let div=document.createElement("div"); div.className="card";
    div.innerHTML=`<label><input type="radio" name="deleteItem" value="${k}"> ${k} x${qty} - $${subtotal}</label>`;
    box.appendChild(div);
  }
  document.getElementById("totalAmount").innerText=total;
  calcChange(); // æ¯æ¬¡æ›´æ–°è¨‚å–®æ™‚è‡ªå‹•é‡ç®—æ‰¾é›¶
}

function renderTodayOrders(){
  let box=document.getElementById("todayOrders"); box.innerHTML="";
  [...allData.orders].reverse().forEach(o=>{
    let div=document.createElement("div"); div.className="card";
    div.innerHTML=`<label><input type="checkbox" class="deleteOrder" value="${o.orderNumber}"> 
      <b>è¨‚å–® #${o.orderNumber}</b> (${o.time})<br>
      ${o.items.map(i=>`${i.name} x${i.qty}`).join(", ")}<br>ç¸½é‡‘é¡: $${o.total}</label>`;
    box.appendChild(div);
  });
}

function deleteSelectedOrders(){
  let checked = document.querySelectorAll(".deleteOrder:checked");
  if(checked.length===0){ alert("è«‹å…ˆé¸æ“‡è¦åˆªé™¤çš„è¨‚å–®"); return; }
  checked.forEach(c=>{
    let orderNum = parseInt(c.value);
    allData.orders = allData.orders.filter(o=>o.orderNumber!==orderNum);
  });
  saveData(); renderAll();
}

function renderItemStats(){
  let stats={};
  allData.orders.forEach(o=>{ 
    o.items.forEach(i=>{
      if(!stats[i.name]) stats[i.name]={qty:0,total:0};
      if(i.name==="ç’°ä¿é¤å…·"){
        stats[i.name].qty += i.qty;
        stats[i.name].total += -5 * i.qty;
      } else {
        stats[i.name].qty += i.qty;
        stats[i.name].total += i.subtotal;
      }
    });
  });

  let order=[
    "å¤§è…¸éºµç·š(å¤§)","å¤§è…¸éºµç·š(å°)","æ¸…éºµç·š(å¤§)","æ¸…éºµç·š(å°)",
    "åŸå‘³è›‹é¤…","èµ·å¸è›‹é¤…","ç‰ç±³è›‹é¤…","ç«è…¿è›‹é¤…","ç¸½åŒ¯è›‹é¤…","è›‹é¤…çš®",
    "ç‚¸è›‹è”¥æ²¹é¤…","ç´…èŒ¶","åŠ 10","åŠ 20","åŠ 30","è›‹","ç’°ä¿é¤å…·"
  ];
  
  let tbody=document.getElementById("itemStats"); 
  tbody.innerHTML="";
  let totalQty=0, totalSales=0;

  order.forEach(k=>{
    let qty=stats[k]?.qty||0;
    let total=stats[k]?.total||0;
    totalQty+=qty; 
    totalSales+=total;
    let tr=document.createElement("tr");
    tr.innerHTML=`<td>${k}</td><td>${qty}</td><td>$${total}</td>`;
    tbody.appendChild(tr);
  });

  let tr=document.createElement("tr");
  tr.innerHTML=`<td><b>åˆè¨ˆ</b></td><td><b>${totalQty}</b></td><td><b>$${totalSales}</b></td>`;
  tbody.appendChild(tr);
}

function calcTotalWithDiscount(orders){
  let sum=0;
  orders.forEach(o=>{
    o.items.forEach(i=>{
      if(i.name==="ç’°ä¿é¤å…·"){
        sum += -5 * i.qty; 
      } else {
        sum += i.subtotal;
      }
    });
  });
  return sum;
}

function renderRevenue(){
  let today = calcTotalWithDiscount(allData.orders);
  document.getElementById("todayRevenue").innerText = today;

  let weekOrders = allData.history.filter(h=>isSameWeek(h.date)).flatMap(h=>h.orders);
  let monthOrders = allData.history.filter(h=>isSameMonth(h.date)).flatMap(h=>h.orders);

  let weekTotal = calcTotalWithDiscount(weekOrders.concat(allData.orders));
  let monthTotal = calcTotalWithDiscount(monthOrders.concat(allData.orders));

  document.getElementById("weekRevenue").innerText = weekTotal;
  document.getElementById("monthRevenue").innerText = monthTotal;
}

function isSameWeek(dateStr){
  let d = new Date(dateStr);
  let today = new Date();
  let weekStart = new Date(today.setDate(today.getDate() - today.getDay() + 1));
  let weekEnd = new Date(today.setDate(weekStart.getDate() + 6));
  return d >= weekStart && d <= weekEnd;
}

function isSameMonth(dateStr){
  let d = new Date(dateStr);
  let today = new Date();
  return d.getMonth() === today.getMonth() && d.getFullYear() === today.getFullYear();
}

function renderHistoryByDate(){
  let date=document.getElementById("historyDate").value;
  let box=document.getElementById("historyOrders"); box.innerHTML="";
  let d=allData.history.find(h=>h.date===date);
  if(d){
    d.orders.forEach(o=>{
      let div=document.createElement("div"); div.className="card";
      div.innerHTML=`è¨‚å–® #${o.orderNumber} (${o.time})<br>
        ${o.items.map(i=>`${i.name} x${i.qty}`).join(", ")}<br>ç¸½é‡‘é¡: $${o.total}`;
      box.appendChild(div);
    });
  } else {
    box.innerHTML="<i>æ­¤æ—¥æœŸç„¡è¨‚å–®ç´€éŒ„</i>";
  }
}

function renderAll(){ renderOrder(); renderTodayOrders(); renderItemStats(); renderRevenue(); }

function showPage(p){
  document.getElementById("frontPage").classList.add("hidden");
  document.getElementById("backPage").classList.add("hidden");
  document.getElementById("frontTab").classList.remove("active");
  document.getElementById("backTab").classList.remove("active");
  if(p==="front"){ 
    document.getElementById("frontPage").classList.remove("hidden"); 
    document.getElementById("frontTab").classList.add("active"); 
  } else { 
    document.getElementById("backPage").classList.remove("hidden"); 
    document.getElementById("backTab").classList.add("active"); 
  }
}

/* ğŸ”¹ è¨ˆç®—æ‰¾é›¶ */
function calcChange(){
  let total = parseInt(document.getElementById("totalAmount").innerText) || 0;
  let pay = parseInt(document.getElementById("payAmount").value) || 0;
  let change = pay - total;
  document.getElementById("changeAmount").innerText = change >= 0 ? change : 0;
}

checkNewDay(); renderAll();
</script>
</body>
</html>
